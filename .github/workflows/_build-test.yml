# Reusable workflow for building and testing Go code
# Called by: on-merge.yml, ci.yml, sync-openapi.yml
name: Build and Test

on:
  workflow_call:
    inputs:
      go-version-file:
        description: 'Path to go.mod file for version detection'
        type: string
        default: 'go.mod'
      ref:
        description: 'Git ref to checkout'
        type: string
        default: ''
      run-lint:
        description: 'Whether to run golangci-lint'
        type: boolean
        default: false
    outputs:
      success:
        description: 'Whether build and tests passed'
        value: ${{ jobs.build.outputs.success }}

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.result.outputs.success }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{ inputs.go-version-file }}
          cache: true

      - name: Run go mod tidy
        run: |
          # Retry logic for go mod operations (network-dependent)
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::go mod tidy - Attempt $attempt of $max_attempts"
            if go mod tidy; then
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((2 ** attempt * 5))
              echo "::warning::go mod tidy failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            fi
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "::error::go mod tidy failed after $max_attempts attempts"
            exit 1
          fi
          git diff --exit-code go.mod go.sum

      - name: Build
        run: |
          # Retry logic for build (may need to download dependencies)
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Build - Attempt $attempt of $max_attempts"
            if go build -v .; then
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((2 ** attempt * 5))
              echo "::warning::Build failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            fi
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "::error::Build failed after $max_attempts attempts"
            exit 1
          fi

      - name: Test
        run: |
          # Retry logic for tests (may have transient failures)
          max_attempts=2
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Test - Attempt $attempt of $max_attempts"
            if go test -v -race ./internal/...; then
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((attempt * 10))
              echo "::warning::Tests failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            fi
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "::error::Tests failed after $max_attempts attempts"
            exit 1
          fi

      - name: Set result
        id: result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: inputs.run-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{ inputs.go-version-file }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          args: --timeout=5m ./internal/... .
