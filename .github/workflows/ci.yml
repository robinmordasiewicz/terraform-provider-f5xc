# CI workflow for pull request validation
# Runs on all PRs and pushes to feature branches
# Replaces: lint.yml
name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'refactor/**'
      - 'auto-generate/**'
      - 'auto-regenerate/**'
      - 'openapi-update'

permissions:
  contents: read
  statuses: write
  checks: write

# Cancel in-progress runs when new commits are pushed to the same PR/branch
concurrency:
  group: ci-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  # Build and Test
  # ═══════════════════════════════════════════════════════════════════════════
  build-test:
    name: Build and Test
    uses: ./.github/workflows/_build-test.yml
    with:
      run-lint: true

  # ═══════════════════════════════════════════════════════════════════════════
  # Constitution Check - Prevents manual commits of generated files
  # ═══════════════════════════════════════════════════════════════════════════
  check-constitution:
    name: Constitution Check
    runs-on: ubuntu-latest
    # Skip for automated branches - they're expected to contain generated files
    if: |
      github.event_name == 'pull_request' &&
      !startsWith(github.head_ref, 'auto-generate/') &&
      !startsWith(github.head_ref, 'auto-regenerate/') &&
      github.head_ref != 'docs/auto-update' &&
      github.head_ref != 'openapi-update'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check for generated files (CLAUDE.md Rule 1)
        run: |
          echo "Checking PR for generated files..."

          # Get list of changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if generator tools are modified - this allows docs/examples changes
          GENERATOR_TOOLS_MODIFIED=false
          if echo "$CHANGED_FILES" | grep -qE "^tools/transform-docs\.go$|^tools/generate-|^templates/"; then
            echo "Generator tools modified - docs/examples changes are allowed"
            GENERATOR_TOOLS_MODIFIED=true
          fi

          # Define patterns for generated files
          # IMPORTANT: These files are ALWAYS generated by CI/CD, NEVER committed manually
          # If there's a bug in generated code, fix the generator (tools/generate-all-schemas.go)
          GENERATED_PATTERNS=(
            # Provider documentation - generated by tfplugindocs + transform-docs.go
            "^docs/resources/.*\.md$"
            "^docs/data-sources/.*\.md$"
            "^docs/functions/.*\.md$"
            "^docs/guides/.*\.md$"
            # Example Terraform files - generated by generate-examples.go
            # (Note: examples/functions/ is manually maintained as source for docs)
            # (Note: examples/guides/ is manually maintained as source for guide docs)
            "^examples/resources/.*\.tf$"
            "^examples/data-sources/.*\.tf$"
            # Provider Go code - generated by generate-all-schemas.go
            # See MANUALLY_MAINTAINED_FILES for exceptions (utility data sources not from OpenAPI)
            "^internal/provider/.*_resource\.go$"
            "^internal/provider/.*_data_source\.go$"
          )

          # Manually maintained files that are EXCEPTIONS to the generated patterns
          # These data sources provide utility functionality not available in F5 OpenAPI specs
          MANUALLY_MAINTAINED_FILES=(
            "internal/provider/functions_registration.go"
            "internal/provider/addon_service_data_source.go"
            "internal/provider/addon_service_activation_status_data_source.go"
            "examples/data-sources/addon_service/data-source.tf"
            "examples/data-sources/addon_service_activation_status/data-source.tf"
          )

          # Patterns allowed when generator tools are modified
          ALLOWED_WITH_GENERATORS=(
            "^docs/resources/.*\.md$"
            "^docs/data-sources/.*\.md$"
            "^docs/functions/.*\.md$"
            "^docs/guides/.*\.md$"
            "^docs/index\.md$"
            "^examples/resources/.*\.tf$"
            "^examples/data-sources/.*\.tf$"
          )

          # Helper function to check if file is manually maintained
          is_manually_maintained() {
            local file="$1"
            for maintained_file in "${MANUALLY_MAINTAINED_FILES[@]}"; do
              if [ "$file" = "$maintained_file" ]; then
                return 0  # true
              fi
            done
            return 1  # false
          }

          # Check for violations
          VIOLATIONS=""
          for file in $CHANGED_FILES; do
            # Skip manually maintained files
            if is_manually_maintained "$file"; then
              continue
            fi
            for pattern in "${GENERATED_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                # If generator tools are modified, check if this pattern is allowed
                if [ "$GENERATOR_TOOLS_MODIFIED" = true ]; then
                  ALLOWED=false
                  for allowed_pattern in "${ALLOWED_WITH_GENERATORS[@]}"; do
                    if echo "$file" | grep -qE "$allowed_pattern"; then
                      ALLOWED=true
                      break
                    fi
                  done
                  if [ "$ALLOWED" = true ]; then
                    continue
                  fi
                fi
                VIOLATIONS="$VIOLATIONS\n  - $file"
                break
              fi
            done
          done

          # Report results
          if [ -n "$VIOLATIONS" ]; then
            echo "::error::PR contains generated files"
            echo "-----------------------------------------------------"
            echo -e "$VIOLATIONS"
            echo "-----------------------------------------------------"
            echo ""
            echo "CLAUDE.md Rule 1: Never Commit Generated Files"
            echo ""
            echo "These files are generated by CI/CD workflows."
            echo ""
            echo "If you need to fix a bug in generated resource code:"
            echo "  1. Fix the generator: tools/generate-all-schemas.go"
            echo "  2. Commit ONLY the generator changes"
            echo "  3. CI/CD will automatically regenerate all resources"
            echo ""
            echo "Note: docs/ and examples/ changes are allowed when"
            echo "generator tools (tools/*.go, templates/) are also"
            echo "modified in the same PR."
            exit 1
          fi

          echo "No generated files detected in PR"

  # ═══════════════════════════════════════════════════════════════════════════
  # Validate documentation will regenerate correctly (for PRs with tool changes)
  # ═══════════════════════════════════════════════════════════════════════════
  validate-docs-generation:
    name: Validate Docs Generation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check if docs regeneration needed
        id: check
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)

          # Check if any files that affect doc generation changed
          if echo "$CHANGED_FILES" | grep -qE "^internal/|^tools/|^templates/"; then
            echo "needs_validation=true" >> $GITHUB_OUTPUT
          else
            echo "needs_validation=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        if: steps.check.outputs.needs_validation == 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Set up Terraform
        if: steps.check.outputs.needs_validation == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Install tfplugindocs
        if: steps.check.outputs.needs_validation == 'true'
        run: |
          # Retry logic for go install (network-dependent)
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Install tfplugindocs - Attempt $attempt of $max_attempts"
            if go install github.com/hashicorp/terraform-plugin-docs/cmd/tfplugindocs@latest; then
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((2 ** attempt * 5))
              echo "::warning::go install failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            fi
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "::error::Failed to install tfplugindocs after $max_attempts attempts"
            exit 1
          fi
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Validate docs generation
        if: steps.check.outputs.needs_validation == 'true'
        run: |
          echo "Validating documentation generation..."

          # Generate examples
          go run tools/generate-examples.go

          # Generate docs with retry logic
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::tfplugindocs generate - Attempt $attempt of $max_attempts"
            if tfplugindocs generate; then
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((2 ** attempt * 5))
              echo "::warning::tfplugindocs failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            fi
          done
          if [ $attempt -gt $max_attempts ]; then
            echo "::error::tfplugindocs failed after $max_attempts attempts"
            exit 1
          fi

          # Transform docs
          go run tools/transform-docs.go

          echo "Documentation generation validated successfully"

  # ═══════════════════════════════════════════════════════════════════════════
  # Validate Mock Fixtures (Issue #327)
  # Ensures generated mock defaults are in sync with api-defaults.json
  # ═══════════════════════════════════════════════════════════════════════════
  validate-mock-fixtures:
    name: Validate Mock Fixtures
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Check if mock fixture regeneration needed
        id: check
        run: |
          # Check if files that affect mock generation changed
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")

          if echo "$CHANGED_FILES" | grep -qE "^tools/api-defaults\.json$|^tools/generate-mock-fixtures\.go$|^internal/mocks/generated_defaults"; then
            echo "needs_validation=true" >> $GITHUB_OUTPUT
          else
            echo "needs_validation=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        if: steps.check.outputs.needs_validation == 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Validate mock fixtures are in sync
        if: steps.check.outputs.needs_validation == 'true'
        run: |
          echo "::group::Regenerating mock fixtures"

          # Check if api-defaults.json exists
          if [ ! -f "tools/api-defaults.json" ]; then
            echo "tools/api-defaults.json not found - skipping validation"
            exit 0
          fi

          # Save current state
          cp internal/mocks/generated_defaults.go /tmp/generated_defaults.go.before

          # Regenerate
          go run tools/generate-mock-fixtures.go
          gofmt -s -w internal/mocks/generated_defaults.go

          echo "::endgroup::"

          # Compare
          if ! diff -q internal/mocks/generated_defaults.go /tmp/generated_defaults.go.before > /dev/null 2>&1; then
            echo "::error::Mock fixtures are out of sync with api-defaults.json"
            echo ""
            echo "The generated_defaults.go file does not match what would be"
            echo "generated from the current api-defaults.json."
            echo ""
            echo "To fix:"
            echo "  1. Run: go run tools/generate-mock-fixtures.go"
            echo "  2. Commit the updated internal/mocks/generated_defaults.go"
            echo ""
            echo "Diff:"
            diff internal/mocks/generated_defaults.go /tmp/generated_defaults.go.before || true
            exit 1
          fi

          echo "Mock fixtures are in sync with api-defaults.json"

      - name: Run mock tests
        if: steps.check.outputs.needs_validation == 'true'
        run: |
          echo "::group::Running mock tests"
          go test -v ./internal/mocks/...
          echo "::endgroup::"

  # ═══════════════════════════════════════════════════════════════════════════
  # Validate MCP Server Build (for PRs affecting MCP server)
  # ═══════════════════════════════════════════════════════════════════════════
  validate-mcp-server:
    name: Validate MCP Server
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: mcp-server
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Check if MCP server validation needed
        id: check
        run: |
          cd ..
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "")

          # Check if MCP server source changed
          if echo "$CHANGED_FILES" | grep -qE "^mcp-server/"; then
            echo "needs_validation=true" >> $GITHUB_OUTPUT
            echo "MCP server files changed - validation needed"
          else
            echo "needs_validation=false" >> $GITHUB_OUTPUT
            echo "No MCP server changes - skipping validation"
          fi

      - name: Setup Node.js
        if: steps.check.outputs.needs_validation == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mcp-server/package-lock.json

      - name: Install dependencies
        if: steps.check.outputs.needs_validation == 'true'
        run: npm ci

      - name: Type check
        if: steps.check.outputs.needs_validation == 'true'
        run: npm run typecheck

      - name: Build
        if: steps.check.outputs.needs_validation == 'true'
        run: npm run build

      - name: Verify build output
        if: steps.check.outputs.needs_validation == 'true'
        run: |
          if [ ! -f "dist/index.js" ]; then
            echo "::error::MCP server build did not produce dist/index.js"
            exit 1
          fi
          echo "MCP server build validated successfully"
