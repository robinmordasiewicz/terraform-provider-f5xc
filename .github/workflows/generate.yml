# Code generation workflow for Terraform Provider
# Automatically regenerates provider code when OpenAPI specs change
name: Generate Provider Code

on:
  # Trigger when OpenAPI specs are updated OR generator tool changes
  push:
    branches:
      - main
    paths:
      - 'docs/specifications/api/**'
      - 'tools/generate-all-schemas.go'

  # Manual trigger with options
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regeneration even if no spec changes detected'
        required: false
        default: 'false'
        type: boolean

  # Allow other workflows to trigger this one
  workflow_call:

permissions:
  contents: write
  pull-requests: write

env:
  SPEC_DIR: docs/specifications/api

jobs:
  generate:
    name: Generate Provider Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Verify specs exist
        id: verify-specs
        run: |
          SPEC_COUNT=$(find ${{ env.SPEC_DIR }} -name "*.json" -type f 2>/dev/null | wc -l)
          echo "ğŸ“ Found ${SPEC_COUNT} OpenAPI spec files in ${{ env.SPEC_DIR }}"
          if [ "$SPEC_COUNT" -eq "0" ]; then
            echo "âš ï¸ No spec files found - skipping generation"
            echo "has_specs=false" >> $GITHUB_OUTPUT
          else
            echo "has_specs=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go
        if: steps.verify-specs.outputs.has_specs == 'true'
        uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Run code generator
        if: steps.verify-specs.outputs.has_specs == 'true'
        run: |
          echo "ğŸ”¨ Running code generator..."
          go run tools/generate-all-schemas.go --spec-dir=${{ env.SPEC_DIR }}

      - name: Run go mod tidy
        if: steps.verify-specs.outputs.has_specs == 'true'
        run: go mod tidy

      - name: Build to verify
        if: steps.verify-specs.outputs.has_specs == 'true'
        run: go build -v .

      - name: Run tests
        if: steps.verify-specs.outputs.has_specs == 'true'
        run: go test -v ./internal/...

      - name: Check for changes
        if: steps.verify-specs.outputs.has_specs == 'true'
        id: git-changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ No code changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Code changes detected:"
            git diff --cached --stat
          fi

      - name: Create Pull Request
        id: create-pr
        if: steps.verify-specs.outputs.has_specs == 'true' && steps.git-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.AUTO_MERGE_TOKEN }}
          commit-message: |
            chore: regenerate provider from latest API specs

            Automated regeneration of Terraform provider code from
            the latest F5 XC OpenAPI specifications.

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>
          branch: auto-generate/api-update
          delete-branch: true
          title: 'ğŸ”„ Regenerate provider from latest API specs'
          body: |
            ## Automated API Update

            This PR was automatically generated by the code generation workflow.

            ### Changes
            - Regenerated resources and data sources from latest OpenAPI specs
            - Updated client types for API compatibility
            - Updated provider registration

            ### Verification
            - âœ… Build passes
            - âœ… Tests pass
            - âœ… Code is formatted

            ---
            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          labels: |
            automated
            api-update

      - name: Enable auto-merge on PR
        if: steps.create-pr.outputs.pull-request-operation == 'created'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
            --auto --squash
