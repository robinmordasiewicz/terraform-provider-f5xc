# Scheduled workflow to sync F5 Distributed Cloud OpenAPI specifications
# Downloads the latest specs and creates a PR if changes are detected
# The on-merge.yml workflow handles regeneration when this PR merges
name: Sync OpenAPI Specs

on:
  schedule:
    # 7am Atlantic Time (11:00 UTC during AST, 10:00 UTC during ADT)
    - cron: '0 11 * * *'
    # 7pm Mountain Time (01:00 UTC next day during MST, 02:00 UTC during MDT)
    - cron: '0 1 * * *'
  workflow_dispatch:

concurrency:
  group: openapi-sync
  cancel-in-progress: false

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  SPEC_DIR: docs/specifications/api
  PR_TITLE: "feat: update F5 Distributed Cloud OpenAPI specifications"

jobs:
  sync:
    name: Sync OpenAPI Specs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for existing open PR
        id: existing_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_COUNT=$(gh pr list --search "in:title \"${{ env.PR_TITLE }}\"" --state open --json number --jq length)
          if [ "$PR_COUNT" -gt "0" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Found existing open PR - skipping"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Download OpenAPI specs
        if: steps.existing_pr.outputs.exists == 'false'
        run: |
          mkdir -p ${{ env.SPEC_DIR }}

          # Retry logic with exponential backoff
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "::group::Download attempt $attempt of $max_attempts"
            if curl -sL --fail --retry 2 --retry-delay 5 -o openapi.zip \
                "https://docs.cloud.f5.com/docs-v2/downloads/f5-distributed-cloud-open-api.zip"; then
              echo "Download successful"
              echo "::endgroup::"
              break
            fi
            echo "::endgroup::"
            attempt=$((attempt + 1))
            if [ $attempt -le $max_attempts ]; then
              sleep_time=$((2 ** attempt * 5))
              echo "::warning::Download failed, retrying in ${sleep_time}s..."
              sleep $sleep_time
            else
              echo "::error::All $max_attempts download attempts failed"
              exit 1
            fi
          done

          unzip -o openapi.zip -d ${{ env.SPEC_DIR }}
          rm openapi.zip

      - name: Check for changes
        if: steps.existing_pr.outputs.exists == 'false'
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in OpenAPI specs"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in OpenAPI specs"
            git reset HEAD
          fi

      - name: Setup Node.js for validation
        if: steps.changes.outputs.changed == 'true'
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Validate OpenAPI specs
        if: steps.changes.outputs.changed == 'true'
        run: |
          npm install -g @apidevtools/swagger-cli
          echo "Validating OpenAPI specifications..."
          VALID=true
          for file in $(find ${{ env.SPEC_DIR }} -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \)); do
            if grep -q -E "(openapi|swagger).*['\"]?[0-9]+\.[0-9]+" "$file" 2>/dev/null; then
              echo "Validating: $file"
              if swagger-cli validate "$file"; then
                echo "âœ… $file is valid"
              else
                echo "âŒ $file validation failed"
                VALID=false
              fi
            fi
          done
          if [ "$VALID" = false ]; then
            echo "::error::Some OpenAPI specs failed validation"
            exit 1
          fi
          echo "âœ… All OpenAPI specs validated successfully"

      - name: Get current date
        if: steps.changes.outputs.changed == 'true'
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create branch and commit
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b openapi-update-${{ steps.date.outputs.date }}
          git add -A
          git commit -m "${{ env.PR_TITLE }}

          Automated sync from F5 Distributed Cloud OpenAPI specifications.

          Source: https://docs.cloud.f5.com/docs-v2/downloads/f5-distributed-cloud-open-api.zip
          Date: ${{ steps.date.outputs.date }}

          When this PR merges, the on-merge workflow will:
          1. Regenerate provider code from the new specs
          2. Regenerate documentation
          3. Create a version tag and release

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"
          git push --force origin openapi-update-${{ steps.date.outputs.date }}

      - name: Find or create tracking issue
        if: steps.changes.outputs.changed == 'true'
        id: issue
        uses: actions/github-script@v8
        with:
          script: |
            const issueTitle = "OpenAPI Spec Update Available";

            // Search for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'openapi-update'
            });

            const existingIssue = issues.data.find(issue => issue.title === issueTitle);

            if (existingIssue) {
              console.log(`Found existing issue #${existingIssue.number}`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Update Detected - ${{ steps.date.outputs.date }}

                A new update to the OpenAPI specification has been detected.
                A pull request has been created for review.`
              });
              return existingIssue.number;
            }

            // Create new issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: `## F5 Distributed Cloud OpenAPI Spec Update

              This issue tracks updates to the F5 Distributed Cloud OpenAPI specification.

              **Source:** https://docs.cloud.f5.com/docs-v2/downloads/f5-distributed-cloud-open-api.zip

              ---

              ### Latest Update - ${{ steps.date.outputs.date }}

              Please review the changes in the associated pull request.`,
              labels: ['openapi-update', 'automated']
            });

            console.log(`Created issue #${issue.data.number}`);
            return issue.data.number;

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "${{ env.PR_TITLE }}" \
            --body "## Summary

          This PR updates the F5 Distributed Cloud OpenAPI specifications.

          **Source:** https://docs.cloud.f5.com/docs-v2/downloads/f5-distributed-cloud-open-api.zip
          **Date:** ${{ steps.date.outputs.date }}
          **Tracking Issue:** #${{ steps.issue.outputs.result }}

          ## What happens when this merges?

          The \`on-merge.yml\` workflow will automatically:
          1. âœ… Detect that OpenAPI specs changed
          2. ðŸ”„ Regenerate provider code from the new specs
          3. ðŸ“š Regenerate documentation
          4. ðŸ·ï¸ Create a version tag
          5. ðŸ“¦ Publish a release

          ## Verification

          - âœ… OpenAPI specs downloaded successfully
          - âœ… All specs validated

          ---
          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Closes #${{ steps.issue.outputs.result }}" \
            --label "automated,openapi-update")

          PR_NUM=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "number=$PR_NUM" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUM"

      - name: Enable auto-merge
        if: steps.create_pr.outputs.number != ''
        env:
          GH_TOKEN: ${{ secrets.AUTO_MERGE_TOKEN }}
        run: |
          gh pr merge ${{ steps.create_pr.outputs.number }} --auto --squash
