name: Update f5xc-auth Dependency

on:
  repository_dispatch:
    types: [f5xc-auth-release]

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependency:
    name: Update f5xc-auth to ${{ github.event.client_payload.version }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update f5xc-auth dependency
        id: update
        working-directory: mcp-server
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Updating @robinmordasiewicz/f5xc-auth to version $VERSION"

          # Update package.json with specific version
          npm install --save-exact @robinmordasiewicz/f5xc-auth@$VERSION

          # Capture changes
          if git diff --quiet package.json package-lock.json; then
            echo "updated=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(mcp): update f5xc-auth to ${{ github.event.client_payload.version }}

            Automated dependency update triggered by upstream release.

            Source: ${{ github.event.client_payload.repository }}@${{ github.event.client_payload.version }}

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: deps/f5xc-auth-${{ github.event.client_payload.version }}
          delete-branch: true
          title: "chore(mcp): update f5xc-auth to ${{ github.event.client_payload.version }}"
          body: |
            ## Automated Dependency Update

            Updates `@robinmordasiewicz/f5xc-auth` from `latest` to `${{ github.event.client_payload.version }}`

            **Source:** ${{ github.event.client_payload.repository }}@${{ github.event.client_payload.version }}

            ### Changes
            - Updated `mcp-server/package.json`
            - Updated `mcp-server/package-lock.json`

            ### Testing
            - [ ] MCP server builds successfully
            - [ ] Authentication tests pass
            - [ ] Integration tests complete

            ### Next Steps
            Once merged, the existing `on-merge.yml` workflow will:
            1. Run build and test validation
            2. Create a new release tag
            3. Publish updated MCP server to npm

            ---
            ü§ñ Auto-generated by upstream f5xc-auth release
          labels: |
            dependencies
            automated
            mcp-server

      - name: Summary
        run: |
          if [ "${{ steps.update.outputs.updated }}" == "true" ]; then
            echo "‚úÖ Created PR to update f5xc-auth to ${{ github.event.client_payload.version }}"
          else
            echo "‚ÑπÔ∏è No update needed - already at version ${{ github.event.client_payload.version }}"
          fi
