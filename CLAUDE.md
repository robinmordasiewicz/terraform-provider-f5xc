# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Claude Constitution: GitHub & Automation Rules

### Core Principle: Automation First

**BEFORE making any changes, analyze `.github/workflows/` to understand existing automation patterns.**

This repository uses CI/CD automation extensively. Respect the automation - do not bypass it.

### Rule 1: Never Commit Generated Files

**Generated/derived files are managed by CI/CD workflows, not manual commits.**

| Directory/File | Generated By | Workflow |
|----------------|--------------|----------|
| `docs/resources/*.md` | `tfplugindocs` + `transform-docs.go` | `docs.yml` |
| `docs/data-sources/*.md` | `tfplugindocs` + `transform-docs.go` | `docs.yml` |
| `docs/api/*.md` | `generate-api-docs.go` | `pages.yml` |
| `docs/nav-api.yml` | `generate-api-docs.go` | `pages.yml` |
| `internal/provider/*_resource.go` | `generate-resources.go` | `generate.yml` |
| `site/` | `mkdocs build` | `pages.yml` |

**Correct behavior**: Commit only source/tool changes. Let workflows generate artifacts.

### Rule 2: Understand the Workflow Chain

```
Source Change → Push to Branch → CI Workflow Runs → Auto-PR Created
```

**Workflows in this repository:**

| Workflow | Trigger | Action | Creates PR? |
|----------|---------|--------|-------------|
| `docs.yml` | Changes to `internal/`, `docs/`, `templates/` | Regenerates provider docs | ✅ Yes |
| `generate.yml` | Changes to `docs/specifications/api/` | Regenerates provider code | ✅ Yes |
| `sync-openapi.yml` | Scheduled (daily) | Syncs OpenAPI specs from F5 | ✅ Yes |
| `pages.yml` | Changes to `docs/`, `mkdocs.yml` | Builds & deploys MkDocs | ❌ Direct deploy |
| `auto-tag.yml` | Push to main (non-docs) | Creates version tag | ❌ Creates tag |
| `release.yml` | Tag push (`v*`) | Publishes release | ❌ Creates release |
| `lint.yml` | All pushes/PRs | Runs tests & linting | ❌ Status checks |

### Rule 3: One Concern Per Commit

When modifying generator tools (e.g., `tools/transform-docs.go`):

✅ **Correct**:
```bash
git add tools/transform-docs.go
git commit -m "feat: add Metadata/Spec grouping to doc transformer"
git push
# Let docs.yml workflow create PR with generated docs
```

❌ **Incorrect**:
```bash
go run tools/transform-docs.go  # DON'T manually run generators
git add tools/transform-docs.go docs/  # DON'T commit generated files
git commit -m "feat: add grouping + regenerate all docs"
```

### Rule 4: Check .gitignore for Generated Patterns

Before committing, verify files aren't in `.gitignore`:

```bash
# Generated documentation (rebuilt at deploy time)
docs/api/
docs/nav-api.yml
site/
```

If a file pattern is in `.gitignore`, it's generated - don't commit it manually.

### Rule 5: Respect Auto-Generated PRs

When you see PRs from `github-actions` bot with labels `automated`, `documentation`:
- These are legitimate CI-generated changes
- Review them for correctness
- Merge or close based on content quality
- Do NOT duplicate their work manually

### Rule 6: Pre-Flight Checklist

Before creating any PR, verify:

- [ ] Analyzed relevant workflows in `.github/workflows/`
- [ ] Checked `.gitignore` for generated file patterns
- [ ] Committing ONLY source code, not generated artifacts
- [ ] Not bypassing automation that handles this task
- [ ] PR contains single concern (not mixed source + generated)

## Project Overview

Community-driven Terraform provider for F5 Distributed Cloud (F5XC) built using the HashiCorp Terraform Plugin Framework. The provider implements F5's public OpenAPI specifications to manage F5XC resources via Terraform.

## Build & Development Commands

```bash
# Build the provider binary
go build -o terraform-provider-f5xc

# Run all tests
go test ./...

# Run acceptance tests (requires F5XC_API_TOKEN)
TF_ACC=1 go test ./... -v -timeout 120m

# Generate documentation (requires terraform CLI)
go generate ./...

# Install locally for testing
mkdir -p ~/.terraform.d/plugins/registry.terraform.io/robinmordasiewicz/f5xc/0.1.0/darwin_arm64
cp terraform-provider-f5xc ~/.terraform.d/plugins/registry.terraform.io/robinmordasiewicz/f5xc/0.1.0/darwin_arm64/
```

## Architecture

### Directory Structure

- `main.go` - Provider entry point with version injection via goreleaser
- `internal/provider/` - All Terraform resources and data sources
- `internal/client/` - F5XC API client (HTTP client with CRUD operations and type definitions)
- `tools/` - Code generation utilities for scaffolding new resources from OpenAPI specs
- `docs/` - Auto-generated provider documentation for Terraform Registry
- `examples/` - Example Terraform configurations

### Resource Implementation Pattern

Each resource follows the Terraform Plugin Framework pattern:

1. **Resource struct** implementing `resource.Resource`, `resource.ResourceWithConfigure`, `resource.ResourceWithImportState`
2. **Model struct** with `tfsdk` tags for state management
3. **CRUD methods**: `Create`, `Read`, `Update`, `Delete`
4. **Registration** in `provider.go` via `Resources()` function

Example reference: `internal/provider/namespace_resource.go`

### Client Architecture

`internal/client/client.go` contains:

- HTTP client wrapper for F5XC API (`Client` struct)
- Type definitions for all F5XC resources (e.g., `Namespace`, `HTTPLoadBalancer`)
- CRUD methods for each resource type following pattern: `Create{Resource}`, `Get{Resource}`, `Update{Resource}`, `Delete{Resource}`

API authentication uses Bearer token: `Authorization: APIToken {token}`

### Code Generation

The `tools/` directory contains generators for scaffolding resources from F5 OpenAPI specs:

- `generate-resources.go` - Generates resource files from OpenAPI specs
- `generate-client-types.go` - Generates client type definitions
- `batch-generate.sh` - Batch generation script

## Environment Variables

- `F5XC_API_TOKEN` - Required API token for F5 Distributed Cloud
- `F5XC_API_URL` - Optional API URL (defaults to `https://console.ves.volterra.io/api`)
- `TF_ACC=1` - Enable acceptance tests

## Key Dependencies

- `github.com/hashicorp/terraform-plugin-framework` - Core Terraform provider SDK
- `github.com/hashicorp/terraform-plugin-log` - Structured logging

## Release Process

Releases are automated via GoReleaser on tag push (`v*`). The workflow:

1. Builds cross-platform binaries
2. Signs checksums with GPG
3. Publishes to GitHub Releases with Terraform Registry manifest
