#!/bin/bash
# Pre-commit hook to prevent committing generated files
# Based on CLAUDE.md Rule 1: Never Commit Generated Files

set -e

# Define patterns for generated files that should never be committed manually
# These files are created by CI/CD workflows from generators in tools/
GENERATED_PATTERNS=(
    # Provider documentation - generated by tfplugindocs + transform-docs.go (on-merge.yml)
    "^docs/resources/.*\.md$"
    "^docs/data-sources/.*\.md$"
    # Provider Go code - generated by generate-all-schemas.go (on-merge.yml)
    "^internal/provider/.*_resource\.go$"
    "^internal/provider/.*_data_source\.go$"
    # Example Terraform files - generated by generate-examples.go (on-merge.yml)
    "^examples/resources/.*\.tf$"
    "^examples/data-sources/.*\.tf$"
)

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "üîç Checking for generated files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No files staged${NC}"
    exit 0
fi

# Check each staged file against generated patterns
VIOLATIONS=()
for file in $STAGED_FILES; do
    for pattern in "${GENERATED_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            VIOLATIONS+=("$file")
            break
        fi
    done
done

# Report violations
if [ ${#VIOLATIONS[@]} -gt 0 ]; then
    echo -e "${RED}‚ùå ERROR: Attempting to commit generated files${NC}"
    echo -e "${YELLOW}"
    echo "The following generated files are staged for commit:"
    echo "-----------------------------------------------------"
    for file in "${VIOLATIONS[@]}"; do
        echo "  - $file"
    done
    echo "-----------------------------------------------------"
    echo ""
    echo "üö´ CLAUDE.md Rule 1: Never Commit Generated Files"
    echo ""
    echo "These files are generated by CI/CD workflows and should not be"
    echo "committed manually. Instead:"
    echo ""
    echo "1. Unstage the generated files:"
    echo "   git restore --staged ${VIOLATIONS[*]}"
    echo ""
    echo "2. If you need to update documentation:"
    echo "   - Modify the generators: tools/transform-docs.go"
    echo "   - Modify the templates: templates/"
    echo "   - Let the docs.yml workflow regenerate files"
    echo ""
    echo "3. If you need to update resources:"
    echo "   - Modify the specifications: docs/specifications/api/"
    echo "   - Let the generate.yml workflow regenerate resources"
    echo ""
    echo "4. If you need to update examples:"
    echo "   - Modify the generator: tools/generate-examples.go"
    echo "   - Let the docs.yml workflow regenerate examples"
    echo ""
    echo "5. Commit only source code changes, not generated artifacts"
    echo -e "${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ No generated files detected${NC}"
exit 0
