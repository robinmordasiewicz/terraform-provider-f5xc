#!/bin/bash
# Pre-commit hook to prevent committing generated files
# Based on CLAUDE.md Rule 1: Never Commit Generated Files
#
# This hook enforces the repository's Constitution which requires that
# generated files are ONLY created by CI/CD automation, never committed manually.

set -e

# Define patterns for generated files that should never be committed manually
# These files are created by CI/CD workflows from generators in tools/
GENERATED_PATTERNS=(
    # Provider documentation - generated by tfplugindocs + transform-docs.go (on-merge.yml)
    "^docs/resources/.*\.md$"
    "^docs/data-sources/.*\.md$"
    "^docs/functions/.*\.md$"
    "^docs/guides/.*\.md$"
    # Provider Go code - generated by generate-all-schemas.go (on-merge.yml)
    "^internal/provider/.*_resource\.go$"
    "^internal/provider/.*_data_source\.go$"
    # Example Terraform files - generated by generate-examples.go (on-merge.yml)
    # Note: examples/functions/ is MANUALLY maintained (source for function doc generation)
    # Note: examples/guides/ is MANUALLY maintained (source for guide doc generation)
    "^examples/resources/.*\.tf$"
    "^examples/data-sources/.*\.tf$"
)

# Manually maintained files that are EXCEPTIONS to the generated patterns
# These data sources are not auto-generated from OpenAPI specs - they provide
# utility functionality not available in the F5 specifications
MANUALLY_MAINTAINED_FILES=(
    "internal/provider/functions_registration.go"
    "internal/provider/addon_service_data_source.go"
    "internal/provider/addon_service_activation_status_data_source.go"
    "examples/data-sources/addon_service/data-source.tf"
    "examples/data-sources/addon_service_activation_status/data-source.tf"
    # MkDocs documentation site index files (navigation, not provider docs)
    "docs/resources/index.md"
    "docs/data-sources/index.md"
    "docs/functions/index.md"
    "docs/guides/index.md"
)

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

echo "ğŸ” Checking for generated files..."

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}âœ… No files staged${NC}"
    exit 0
fi

# Helper function to check if a file is manually maintained
is_manually_maintained() {
    local file="$1"
    for maintained_file in "${MANUALLY_MAINTAINED_FILES[@]}"; do
        if [ "$file" = "$maintained_file" ]; then
            return 0  # true - file is manually maintained
        fi
    done
    return 1  # false - file is not in the exception list
}

# Check each staged file against generated patterns
VIOLATIONS=()
for file in $STAGED_FILES; do
    # Skip files that are manually maintained exceptions
    if is_manually_maintained "$file"; then
        continue
    fi
    for pattern in "${GENERATED_PATTERNS[@]}"; do
        if echo "$file" | grep -qE "$pattern"; then
            VIOLATIONS+=("$file")
            break
        fi
    done
done

# Report violations
if [ ${#VIOLATIONS[@]} -gt 0 ]; then
    echo ""
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘                    ğŸš¨ CONSTITUTION VIOLATION DETECTED ğŸš¨                     â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${BOLD}CLAUDE.md Rule 1: Never Commit Generated Files${NC}"
    echo ""
    echo -e "${YELLOW}You are attempting to commit ${#VIOLATIONS[@]} generated file(s):${NC}"
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    for file in "${VIOLATIONS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $file"
    done
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚                    WHY THIS RULE EXISTS                                    â”‚${NC}"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
    echo "  This repository uses a CI/CD automation pipeline that generates files"
    echo "  automatically. Manually committing generated files causes:"
    echo ""
    echo "    â€¢ Merge conflicts when automation regenerates the same files"
    echo "    â€¢ Double-tagging and cascade effects in the release process"
    echo "    â€¢ Inconsistency between source code and generated artifacts"
    echo "    â€¢ Difficulty tracking what changes were intentional"
    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚                    HOW CI/CD AUTOMATION WORKS                              â”‚${NC}"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
    echo "  When you push changes to source files (generators, specs, templates),"
    echo "  the ${BOLD}on-merge.yml${NC} workflow automatically:"
    echo ""
    echo "    1. Detects changes to generator tools or specifications"
    echo "    2. Runs the appropriate generators:"
    echo "       â€¢ tools/generate-all-schemas.go â†’ *_resource.go, *_data_source.go"
    echo "       â€¢ tools/generate-examples.go    â†’ examples/resources/, examples/data-sources/"
    echo "       â€¢ tools/transform-docs.go       â†’ docs/resources/, docs/data-sources/"
    echo "       â€¢ tfplugindocs                  â†’ docs/functions/"
    echo "    3. Creates a consolidated PR with all regenerated files"
    echo "    4. Handles tagging and release (ONCE, avoiding double-tags)"
    echo ""
    echo -e "${CYAN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${CYAN}â”‚                    HOW TO FIX THIS                                         â”‚${NC}"
    echo -e "${CYAN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
    echo "  ${BOLD}Step 1:${NC} Unstage the generated files:"
    echo ""
    echo -e "    ${GREEN}git restore --staged ${VIOLATIONS[*]}${NC}"
    echo ""
    echo "  ${BOLD}Step 2:${NC} Commit only the SOURCE files (generators, specs, templates):"
    echo ""
    echo "    â€¢ To update resources:  Edit ${BOLD}tools/generate-all-schemas.go${NC}"
    echo "    â€¢ To update docs:       Edit ${BOLD}tools/transform-docs.go${NC} or ${BOLD}templates/${NC}"
    echo "    â€¢ To update examples:   Edit ${BOLD}tools/generate-examples.go${NC}"
    echo "    â€¢ To add new resources: Edit ${BOLD}docs/specifications/api/*.json${NC}"
    echo ""
    echo "  ${BOLD}Step 3:${NC} Push your source changes. CI/CD will automatically regenerate"
    echo "         all affected files and create a PR for review."
    echo ""
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo -e "${BOLD}For more details, see:${NC}"
    echo "  â€¢ CLAUDE.md - Part 2: CI/CD Automation Rules"
    echo "  â€¢ .github/workflows/on-merge.yml - The orchestrator workflow"
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}âœ… No generated files detected${NC}"
exit 0
